---
- name: Block
  tags:
    - always
  block:
    - name: Copy the wireguard connection template file
      ansible.builtin.template:
        src: "wireguardprofile.conf.j2"
        dest: "{{ ansible_facts['env']['HOME'] }}/{{ wireguard_client_setup_connection_name }}.conf"
        mode: '0600'

    - name: Reload connections
      ansible.builtin.command: nmcli connection reload

    - name: Import wireguard profile
      ansible.builtin.command: "nmcli connection import type wireguard file {{ wireguard_client_setup_connection_name }}.conf"
      args:
        chdir: "{{ ansible_facts['env']['HOME'] }}"
        creates: "/etc/NetworkManager/system-connections/{{ wireguard_client_setup_connection_name }}.nmconnection"

    - name: Configure autoconnect
      community.general.nmcli:
        conn_name: "{{ wireguard_client_setup_connection_name }}"
        autoconnect: "{{ wireguard_client_setup_autoconnect | default(false) }}"
        state: present

    - name: Reload connections
      ansible.builtin.command: nmcli connection reload

    - name: Cleanup wireguard template file
      ansible.builtin.file:
        path: "{{ ansible_facts['env']['HOME'] }}/{{ wireguard_client_setup_connection_name }}.conf"
        state: absent
...
